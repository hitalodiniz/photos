#!/usr/bin/env sh
# Nota: As linhas abaixo s√£o necess√°rias para Husky v9
# O aviso de deprecia√ß√£o √© apenas para vers√µes futuras (v10+)
. "$(dirname -- "$0")/_/husky.sh"

# üîí PROTE√á√ÉO DE ARQUIVOS CR√çTICOS DE AUTENTICA√á√ÉO
# Este hook valida mudan√ßas em arquivos cr√≠ticos de seguran√ßa
# 
# Se este hook n√£o funcionar no Windows, use a vers√£o PowerShell:
# .husky/pre-commit.ps1 (j√° criada como alternativa)

CRITICAL_FILES=(
  "src/middleware.ts"
  "src/app/api/auth/callback/route.ts"
  "src/core/services/auth.service.ts"
  "src/hooks/useSupabaseSession.ts"
  "src/contexts/AuthContext.tsx"
  "src/lib/supabase.client.ts"
  "src/lib/supabase.server.ts"
  "src/app/api/auth/google/route.ts"
  "src/core/services/google.service.ts"
  "src/core/logic/auth-gallery.ts"
)

# Verifica se algum arquivo cr√≠tico foi modificado
CHANGED_CRITICAL_FILES=()
for file in "${CRITICAL_FILES[@]}"; do
  if git diff --cached --name-only | grep -q "^$file$"; then
    CHANGED_CRITICAL_FILES+=("$file")
  fi
done

# Se h√° arquivos cr√≠ticos modificados, exige confirma√ß√£o
if [ ${#CHANGED_CRITICAL_FILES[@]} -gt 0 ]; then
  echo ""
  echo "‚ö†Ô∏è  ‚ö†Ô∏è  ‚ö†Ô∏è  ATEN√á√ÉO: ARQUIVOS CR√çTICOS DE AUTENTICA√á√ÉO MODIFICADOS ‚ö†Ô∏è  ‚ö†Ô∏è  ‚ö†Ô∏è"
  echo ""
  echo "Os seguintes arquivos cr√≠ticos foram modificados:"
  for file in "${CHANGED_CRITICAL_FILES[@]}"; do
    echo "  üî¥ $file"
  done
  echo ""
  echo "üìã Checklist obrigat√≥rio antes de commitar:"
  echo "  [ ] Li CRITICAL_AUTH_FILES.md"
  echo "  [ ] Entendi o impacto da mudan√ßa"
  echo "  [ ] Criei/atualizei testes unit√°rios"
  echo "  [ ] Testei localmente"
  echo "  [ ] Atualizei documenta√ß√£o se necess√°rio"
  echo "  [ ] Solicitei revis√£o de c√≥digo"
  echo ""
  echo "‚ö†Ô∏è  Estas mudan√ßas podem afetar a seguran√ßa da aplica√ß√£o!"
  echo ""
  read -p "Confirma que voc√™ seguiu o checklist? (digite 'SIM' para continuar): " confirmation
  
  if [ "$confirmation" != "SIM" ]; then
    echo ""
    echo "‚ùå Commit cancelado. Por favor, revise o checklist antes de continuar."
    echo "üìñ Consulte CRITICAL_AUTH_FILES.md para mais informa√ß√µes."
    exit 1
  fi
  
  echo ""
  echo "‚úÖ Confirma√ß√£o recebida. Continuando com o commit..."
  echo ""
fi

# Executa testes
echo "üß™ Executando testes..."
npm test
TEST_EXIT_CODE=$?

if [ $TEST_EXIT_CODE -ne 0 ]; then
  echo ""
  echo "‚ùå Testes falharam! Commit cancelado."
  echo "‚ö†Ô∏è  Por favor, corrija os testes antes de commitar."
  exit 1
fi

# Executa build
echo "üî® Executando build..."
npm run build
BUILD_EXIT_CODE=$?

if [ $BUILD_EXIT_CODE -ne 0 ]; then
  echo ""
  echo "‚ùå Build falhou! Commit cancelado."
  echo "‚ö†Ô∏è  Por favor, corrija os erros de build antes de commitar."
  exit 1
fi

echo ""
echo "‚úÖ Todos os checks passaram. Commit permitido."
exit 0
