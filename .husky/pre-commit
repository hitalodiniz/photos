#!/usr/bin/env sh
# Nota: As linhas abaixo s√£o necess√°rias para Husky v9
# O aviso de deprecia√ß√£o √© apenas para vers√µes futuras (v10+)
. "$(dirname -- "$0")/_/husky.sh"

# üõ°Ô∏è SISTEMA DE PROTE√á√ÉO DE ARQUIVOS CR√çTICOS
# Este hook protege arquivos cr√≠ticos de altera√ß√µes n√£o autorizadas
# Arquivos de autentica√ß√£o, autoriza√ß√£o e APIs do Google Drive s√£o protegidos

# Verifica se tem flag de permiss√£o (via vari√°vel de ambiente)
ALLOW_CRITICAL=false
if [ "$ALLOW_CRITICAL_CHANGES" = "true" ]; then
  ALLOW_CRITICAL=true
fi

# Executa prote√ß√£o de arquivos cr√≠ticos
echo "üõ°Ô∏è  Verificando prote√ß√£o de arquivos cr√≠ticos..."
if [ "$ALLOW_CRITICAL" = "true" ]; then
  node scripts/protect-critical-files.js --allow-critical-changes
else
  node scripts/protect-critical-files.js
fi
PROTECTION_EXIT_CODE=$?

if [ $PROTECTION_EXIT_CODE -ne 0 ]; then
  echo ""
  echo "‚ùå Commit bloqueado por prote√ß√£o de arquivos cr√≠ticos!"
  echo "‚ö†Ô∏è  Use --allow-critical-changes se realmente precisar alterar arquivos cr√≠ticos."
  echo "üìñ Leia PROTECTION_SYSTEM.md para mais informa√ß√µes."
  exit 1
fi

# Valida imports do pacote
echo "üîç Validando imports do pacote cr√≠tico..."
node scripts/validate-package-imports.js
IMPORT_VALIDATION_EXIT_CODE=$?

if [ $IMPORT_VALIDATION_EXIT_CODE -ne 0 ]; then
  echo ""
  echo "‚ùå Commit bloqueado por imports diretos de arquivos cr√≠ticos!"
  echo "‚ö†Ô∏è  Use apenas a API p√∫blica: import { ... } from '@photos/core-auth'"
  echo "üìñ Leia SERVICES_ARCHITECTURE.md para mais informa√ß√µes."
  exit 1
fi

# Executa testes (apenas se n√£o for commit r√°pido)
if [ -z "$SKIP_TESTS" ]; then
  echo "üß™ Executando testes cr√≠ticos..."
  npm run test:critical 2>/dev/null || npm test
  TEST_EXIT_CODE=$?

  if [ $TEST_EXIT_CODE -ne 0 ]; then
    echo ""
    echo "‚ùå Testes falharam! Commit cancelado."
    echo "‚ö†Ô∏è  Por favor, corrija os testes antes de commitar."
    exit 1
  fi
fi

echo ""
echo "‚úÖ Todos os checks passaram. Commit permitido."
exit 0
